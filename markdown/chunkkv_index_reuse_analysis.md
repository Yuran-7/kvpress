# ChunkKV å±‚çº§é—´ç´¢å¼•å¤ç”¨åˆ†æ

## ğŸ” é—®é¢˜
**ChunkKV è®ºæ–‡å£°ç§°æœ‰"å±‚çº§é—´ç´¢å¼•å¤ç”¨"ï¼ˆLayer-wise Index Reuseï¼‰ï¼Œå®é™…æºç æ˜¯å¦å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼Ÿ**

---

## ğŸ“– è®ºæ–‡æè¿°

æ ¹æ®è®ºæ–‡ (arXiv:2502.00299)ï¼ŒChunkKV çš„å±‚çº§é—´ç´¢å¼•å¤ç”¨æœºåˆ¶åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

### ç†è®ºè®¾è®¡
1. **å®šä¹‰å±‚ç»„**ï¼šå°†è¿ç»­çš„ `N_reuse` å±‚åˆ†ä¸ºä¸€ç»„
   - ä¾‹å¦‚ï¼š`{l, l+1, ..., l+N_reuse-1}`

2. **é¦–å±‚è®¡ç®—ç´¢å¼•**ï¼šåªåœ¨ç»„çš„ç¬¬ä¸€å±‚ `l` æ‰§è¡Œå®Œæ•´çš„ ChunkKV å‹ç¼©
   - è®¡ç®—å…¨å±€é‡è¦æ€§åˆ†æ•°
   - æ‰§è¡ŒåŸºäº Chunk çš„é€‰æ‹©
   - è·å¾—ä¿ç•™çš„ Token ç´¢å¼• `I_l`

3. **åç»­å±‚å¤ç”¨ç´¢å¼•**ï¼šç»„å†…å…¶ä½™å±‚ `l+1, l+2, ..., l+N_reuse-1` ç›´æ¥å¤ç”¨ `I_l`
   - æ— éœ€é‡æ–°è®¡ç®—é‡è¦æ€§åˆ†æ•°
   - ç›´æ¥ä½¿ç”¨ç›¸åŒçš„ç´¢å¼•ä» KV Cache ä¸­é€‰æ‹© Token

### å£°ç§°çš„ä¼˜åŠ¿
- **é™ä½è®¡ç®—å¼€é”€**ï¼šå‡å°‘ 26.5% çš„è®¡ç®—é‡
- **æå‡ååé‡**ï¼šç´¢å¼•è®¡ç®—åªåœ¨æ¯ç»„çš„ç¬¬ä¸€å±‚æ‰§è¡Œ
- **ä¿æŒæ€§èƒ½**ï¼šåœ¨ç›¸åŒå‹ç¼©ç‡ä¸‹ï¼Œç²¾åº¦æå‡æœ€é«˜ 8.7%

---

## ğŸ§ª æºç åˆ†æ

### å½“å‰å®ç° (`kvpress/presses/chunkkv_press.py`)

è®©æˆ‘ä»¬é€è¡Œæ£€æŸ¥æºç ä¸­æ˜¯å¦æœ‰ç´¢å¼•å¤ç”¨çš„ç—•è¿¹ï¼š

#### 1ï¸âƒ£ **ç±»å®šä¹‰ä¸å‚æ•°** (ç¬¬ 13-35 è¡Œ)
```python
@dataclass
class ChunkKVPress(BasePress):
    press: ScorerPress
    chunk_length: int = 20
```

**è§‚å¯Ÿ**ï¼š
- âŒ æ²¡æœ‰ `N_reuse` å‚æ•°
- âŒ æ²¡æœ‰ `layer_group_size` ä¹‹ç±»çš„é…ç½®
- âŒ æ²¡æœ‰ç”¨äºå­˜å‚¨ç´¢å¼•çš„ç¼“å­˜å˜é‡

---

#### 2ï¸âƒ£ **å‹ç¼©æ–¹æ³•ç­¾å** (ç¬¬ 51-59 è¡Œ)
```python
def compress(
    self,
    module: nn.Module,
    hidden_states: torch.Tensor,
    keys: torch.Tensor,
    values: torch.Tensor,
    attentions: torch.Tensor,
    kwargs: dict,
) -> tuple[torch.Tensor, torch.Tensor]:
```

**è§‚å¯Ÿ**ï¼š
- âœ… æ¥æ”¶ `module` å‚æ•°ï¼ˆæœ‰ `module.layer_idx` å±æ€§ï¼‰
- âŒ ä½†æ²¡æœ‰æ£€æŸ¥ `layer_idx` çš„é€»è¾‘
- âŒ æ²¡æœ‰æ ¹æ®å±‚çº§å†³å®šæ˜¯å¦è·³è¿‡è®¡ç®—

---

#### 3ï¸âƒ£ **æ ¸å¿ƒå‹ç¼©é€»è¾‘** (ç¬¬ 70-126 è¡Œ)
```python
# 1. Calculate global scores first (æ¯æ¬¡éƒ½è®¡ç®—!)
global_scores = self.press.score(
    module, hidden_states, keys, values, attentions, kwargs
)

# 2. Calculate chunk scores (æ¯æ¬¡éƒ½è®¡ç®—!)
# ...åˆ†å—é€»è¾‘...

# 3. Select top chunks (æ¯æ¬¡éƒ½é€‰æ‹©!)
top_chunks = chunk_scores.topk(n_chunks_kept, dim=-1)

# 4. Create indices (æ¯æ¬¡éƒ½åˆ›å»ºæ–°ç´¢å¼•!)
indices = []
for chunk_idx in top_chunks.indices[0]:
    # ...æ„å»ºç´¢å¼•...
```

**è§‚å¯Ÿ**ï¼š
- âŒ **æ¯å±‚éƒ½è°ƒç”¨** `self.press.score`
- âŒ **æ¯å±‚éƒ½é‡æ–°è®¡ç®—** chunk scores
- âŒ **æ¯å±‚éƒ½é‡æ–°é€‰æ‹©** top chunks
- âŒ **æ²¡æœ‰ä»»ä½•ç´¢å¼•ç¼“å­˜æˆ–å¤ç”¨æœºåˆ¶**

---

#### 4ï¸âƒ£ **æœç´¢å…³é”®è¯æ®**

ä½¿ç”¨ `grep` æœç´¢å…³é”®è¯ï¼š
```bash
# æœç´¢ "layer_idx" åœ¨ chunkkv_press.py ä¸­
âŒ æ— ç»“æœ

# æœç´¢ "reuse" åœ¨æ•´ä¸ª presses ç›®å½•
âŒ æ— ç»“æœ

# æœç´¢ "cache" æˆ– "store" çš„ç´¢å¼•å˜é‡
âŒ æ— ç»“æœ
```

---

## âŒ ç»“è®ºï¼šæœªå®ç°ç´¢å¼•å¤ç”¨

### è¯æ®æ€»ç»“

| è®ºæ–‡ç‰¹æ€§ | æºç å®ç° | çŠ¶æ€ |
|---------|---------|------|
| å®šä¹‰å±‚ç»„ (N_reuse) | âŒ æ— ç›¸å…³å‚æ•° | **æœªå®ç°** |
| é¦–å±‚è®¡ç®—ç´¢å¼• | âŒ æ¯å±‚éƒ½è®¡ç®— | **æœªå®ç°** |
| åç»­å±‚å¤ç”¨ç´¢å¼• | âŒ æ¯å±‚ç‹¬ç«‹è®¡ç®— | **æœªå®ç°** |
| ç´¢å¼•ç¼“å­˜æœºåˆ¶ | âŒ å®Œå…¨æ²¡æœ‰ | **æœªå®ç°** |
| æ£€æŸ¥ layer_idx | âŒ ä»ä¸æ£€æŸ¥ | **æœªå®ç°** |

### å®é™…æ‰§è¡Œæµç¨‹
å½“å‰æºç çš„çœŸå®è¡Œä¸ºï¼š
1. **Layer 0**: è®¡ç®— scores â†’ é€‰æ‹© chunks â†’ ç”Ÿæˆç´¢å¼• `I_0`
2. **Layer 1**: è®¡ç®— scores â†’ é€‰æ‹© chunks â†’ ç”Ÿæˆç´¢å¼• `I_1` (ç‹¬ç«‹è®¡ç®—ï¼Œæœªå¤ç”¨ `I_0`)
3. **Layer 2**: è®¡ç®— scores â†’ é€‰æ‹© chunks â†’ ç”Ÿæˆç´¢å¼• `I_2` (ç‹¬ç«‹è®¡ç®—)
4. ...
5. **Layer 31**: è®¡ç®— scores â†’ é€‰æ‹© chunks â†’ ç”Ÿæˆç´¢å¼• `I_31` (ç‹¬ç«‹è®¡ç®—)

**æ¯å±‚éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„è®¡ç®—ï¼Œæ²¡æœ‰ä»»ä½•ç´¢å¼•å¤ç”¨ã€‚**

---

## ğŸ¤” å¯èƒ½çš„åŸå› 

### 1. ç®€åŒ–å®ç°
- kvpress åº“å¯èƒ½ä¼˜å…ˆå®ç°æ ¸å¿ƒçš„ Chunk-wise é€‰æ‹©æœºåˆ¶
- ç´¢å¼•å¤ç”¨ä½œä¸ºæ€§èƒ½ä¼˜åŒ–ï¼Œå¯èƒ½è¢«æ¨è¿Ÿåˆ°åç»­ç‰ˆæœ¬

### 2. å·¥ç¨‹æƒè¡¡
- ç´¢å¼•å¤ç”¨éœ€è¦é¢å¤–çš„çŠ¶æ€ç®¡ç†ï¼ˆå­˜å‚¨ä¸Šä¸€å±‚çš„ç´¢å¼•ï¼‰
- å¯èƒ½ä¸ kvpress çš„æ— çŠ¶æ€è®¾è®¡ç†å¿µå†²çª
- Hook æœºåˆ¶ä¸‹æ¯å±‚ç‹¬ç«‹è°ƒç”¨ï¼Œå®ç°å¤ç”¨éœ€è¦å¤–éƒ¨çŠ¶æ€

### 3. æ€§èƒ½æ”¶ç›Šä¸æ˜æ˜¾
- åœ¨æŸäº›ç¡¬ä»¶/æ¡†æ¶ä¸‹ï¼Œç´¢å¼•å¤ç”¨çš„æ”¶ç›Šå¯èƒ½ä½äºè®ºæ–‡å£°ç§°çš„ 26.5%
- å¯èƒ½å­˜åœ¨å…¶ä»–æœªå…¬å¼€çš„å®ç°éš¾åº¦

---

## ğŸ“‹ å¦‚æœè¦å®ç°ç´¢å¼•å¤ç”¨ï¼Œéœ€è¦æ·»åŠ ä»€ä¹ˆï¼Ÿ

### ä¼ªä»£ç ç¤ºä¾‹
```python
@dataclass
class ChunkKVPress(BasePress):
    press: ScorerPress
    chunk_length: int = 20
    N_reuse: int = 4  # æ–°å¢ï¼šæ¯ç»„å¤ç”¨çš„å±‚æ•°
    
    def __post_init__(self):
        super().__post_init__()
        self._cached_indices = None  # æ–°å¢ï¼šç¼“å­˜çš„ç´¢å¼•
        self._last_layer_idx = None  # æ–°å¢ï¼šä¸Šæ¬¡è®¡ç®—çš„å±‚çº§

    def compress(self, module, ...):
        layer_idx = module.layer_idx
        
        # åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—ç´¢å¼•
        if layer_idx % self.N_reuse == 0:
            # è¿™æ˜¯ç»„çš„ç¬¬ä¸€å±‚ï¼Œéœ€è¦è®¡ç®—
            global_scores = self.press.score(...)
            # ...è®¡ç®— indices...
            self._cached_indices = indices  # ç¼“å­˜ç´¢å¼•
        else:
            # è¿™æ˜¯ç»„å†…çš„åç»­å±‚ï¼Œç›´æ¥å¤ç”¨
            indices = self._cached_indices
        
        # ä½¿ç”¨ indices è¿›è¡Œå‹ç¼©
        keys = keys.gather(2, indices)
        values = values.gather(2, indices)
        return keys, values
```

---

## âœ… æœ€ç»ˆç­”æ¡ˆ

**ChunkKV çš„æºç  (`kvpress` åº“ä¸­) æ²¡æœ‰å®ç°è®ºæ–‡æ‰€è¿°çš„"å±‚çº§é—´ç´¢å¼•å¤ç”¨"æœºåˆ¶ã€‚**

- å½“å‰å®ç°åªåŒ…å«äº† **Chunk-wise Token Selection** çš„æ ¸å¿ƒç®—æ³•
- **æ¯ä¸€å±‚éƒ½ç‹¬ç«‹è®¡ç®—é‡è¦æ€§åˆ†æ•°å’Œé€‰æ‹©ç´¢å¼•**
- æ²¡æœ‰ä»»ä½•è·¨å±‚ç´¢å¼•ç¼“å­˜æˆ–å¤ç”¨çš„ä»£ç 
- è¿™å¯èƒ½å¯¼è‡´å®é™…æ€§èƒ½ä½äºè®ºæ–‡ä¸­å£°ç§°çš„ä¼˜åŒ–æ•ˆæœï¼ˆ-26.5% è®¡ç®—é‡ï¼‰

å¦‚æœä½ åœ¨å®éªŒä¸­å‘ç° ChunkKV çš„æ€§èƒ½ä¸è®ºæ–‡ä¸ç¬¦ï¼Œè¿™ä¸ªç¼ºå¤±çš„ä¼˜åŒ–å¾ˆå¯èƒ½å°±æ˜¯åŸå› ä¹‹ä¸€ã€‚
