# AdaKV ä¸ SnapKV çš„å…³ç³»è§£æ

## ğŸ¯ é—®é¢˜
åœ¨ `leaderboard.sh` ä¸­çœ‹åˆ° `adakv_snapkv`ï¼Œå®ƒä¸å•ç‹¬çš„ `snapkv` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä»€ä¹ˆè¿˜æœ‰ä¸€ä¸ª `adakv_compactor`ï¼Ÿ

---

## ğŸ“– æ¦‚å¿µæ¾„æ¸…

### 1ï¸âƒ£ **SnapKV** - åŸºç¡€å‹ç¼©æ–¹æ³•
```python
# evaluate_registry.py ç¬¬ 100 è¡Œ
"snapkv": SnapKVPress()
```

**ä½œç”¨**ï¼š
- ä½¿ç”¨æœ€å `window_size` ä¸ª Token çš„æ³¨æ„åŠ›æ¥è¯„ä¼°å‰é¢ Token çš„é‡è¦æ€§
- åœ¨**æ‰€æœ‰ KV Head ä¸Šç»Ÿä¸€åº”ç”¨**ç›¸åŒçš„å‹ç¼©ç‡
- **Head çº§åˆ«**ï¼šæ‰€æœ‰ Head ä¿ç•™åŒæ ·æ•°é‡çš„ Token

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥
- âŒ ä¸è€ƒè™‘ä¸åŒ Head çš„å·®å¼‚æ€§ï¼ˆæœ‰äº› Head å¯èƒ½éœ€è¦æ›´å¤šå†å²ï¼Œæœ‰äº›åˆ™ä¸éœ€è¦ï¼‰

---

### 2ï¸âƒ£ **AdaKV** - è‡ªé€‚åº”åŒ…è£…å™¨
```python
# evaluate_registry.py ç¬¬ 74 è¡Œ
"adakv_snapkv": AdaKVPress(SnapKVPress())
```

**ä½œç”¨**ï¼š
- `AdaKV` æ˜¯ä¸€ä¸ª**è£…é¥°å™¨/åŒ…è£…å™¨**ï¼Œä¸æ˜¯ç‹¬ç«‹çš„å‹ç¼©ç®—æ³•
- å®ƒå¯ä»¥åŒ…è£…ä»»ä½• `ScorerPress`ï¼ˆå¦‚ SnapKVã€ExpectedAttentionã€Compactor ç­‰ï¼‰
- æä¾›**è‡ªé€‚åº”çš„ Head çº§å‹ç¼©**

**æ ¸å¿ƒæœºåˆ¶** (adakv_press.py ç¬¬ 53-78 è¡Œ)ï¼š
1. è°ƒç”¨å†…éƒ¨ pressï¼ˆå¦‚ SnapKVï¼‰è®¡ç®—æ¯ä¸ª Token çš„é‡è¦æ€§åˆ†æ•°
2. **è·¨ Head è¿›è¡Œå…¨å±€ Top-K é€‰æ‹©**ï¼ˆè€Œä¸æ˜¯æ¯ä¸ª Head ç‹¬ç«‹é€‰æ‹©ï¼‰
3. **å®‰å…¨ä¿æŠ¤**ï¼šç¡®ä¿æ¯ä¸ª Head è‡³å°‘ä¿ç•™ `alpha_safeguard * n_kept` ä¸ª Tokenï¼ˆé»˜è®¤ 20%ï¼‰

---

## ğŸ”„ å¯¹æ¯”ç¤ºä¾‹

å‡è®¾æœ‰ **4 ä¸ª KV Head**ï¼Œåºåˆ—é•¿åº¦ **100**ï¼Œå‹ç¼©ç‡ **50%**ï¼ˆä¿ç•™ 50 ä¸ª Tokenï¼‰ï¼š

### åœºæ™¯ 1: `snapkv`ï¼ˆåŸºç¡€ç‰ˆæœ¬ï¼‰
```
æ¯ä¸ª Head ç‹¬ç«‹å‹ç¼©ï¼Œæ¯ä¸ªéƒ½ä¿ç•™ 50 ä¸ª Tokenï¼š
Head 0: ä¿ç•™ 50/100 Token (50%)
Head 1: ä¿ç•™ 50/100 Token (50%)
Head 2: ä¿ç•™ 50/100 Token (50%)
Head 3: ä¿ç•™ 50/100 Token (50%)

æ€» KV å¯¹ï¼š4 * 50 = 200
```

**é—®é¢˜**ï¼š
- æŸäº› Head å¯èƒ½åªå…³æ³¨å±€éƒ¨ä¿¡æ¯ï¼Œä¸éœ€è¦ä¿ç•™ 50 ä¸ª
- æŸäº› Head å¯èƒ½éœ€è¦æ›´é•¿çš„å†å²ï¼Œ50 ä¸ªä¸å¤Ÿ

---

### åœºæ™¯ 2: `adakv_snapkv`ï¼ˆè‡ªé€‚åº”ç‰ˆæœ¬ï¼‰
```
å…¨å±€ä¼˜åŒ–ï¼Œè·¨ Head åˆ†é… Tokenï¼ˆæ€»å…±ä¿ç•™ 200 ä¸ª KV å¯¹ï¼‰ï¼š
Head 0: ä¿ç•™ 70/100 Token (70%) â† é‡è¦ Headï¼Œå¤šä¿ç•™
Head 1: ä¿ç•™ 40/100 Token (40%)
Head 2: ä¿ç•™ 60/100 Token (60%)
Head 3: ä¿ç•™ 30/100 Token (30%) â† ä¸å¤ªé‡è¦ï¼Œå°‘ä¿ç•™

æ€» KV å¯¹ï¼š70+40+60+30 = 200 (ä¸ snapkv ç›¸åŒ)
```

**ä¼˜åŠ¿**ï¼š
- âœ… **å·®å¼‚åŒ–å‹ç¼©**ï¼šæ ¹æ®æ¯ä¸ª Head çš„å®é™…éœ€æ±‚åˆ†é…èµ„æº
- âœ… **å…¨å±€æœ€ä¼˜**ï¼šåœ¨ç›¸åŒçš„æ€» KV å¯¹æ•°ä¸‹ï¼Œä¿ç•™æœ€é‡è¦çš„ä¿¡æ¯
- âœ… **å®‰å…¨ä¿æŠ¤**ï¼šæ¯ä¸ª Head è‡³å°‘ä¿ç•™ 10 ä¸ª Tokenï¼ˆ50 * 20% = 10ï¼‰

---

## ğŸ“‹ æ³¨å†Œè¡¨ä¸­çš„ AdaKV å˜ä½“

| åç§° | å®šä¹‰ | è¯´æ˜ |
|------|------|------|
| **adakv_snapkv** | `AdaKVPress(SnapKVPress())` | ç”¨ AdaKV åŒ…è£… SnapKVï¼Œå®ç° Head è‡ªé€‚åº”å‹ç¼© |
| **adakv_compactor** | `AdaKVPress(CompactorPress())` | ç”¨ AdaKV åŒ…è£… Compactor |
| **expected_attention** | `AdaKVPress(ExpectedAttentionPress(...))` | ç”¨ AdaKV åŒ…è£… ExpectedAttention |
| **critical_adakv_snapkv** | `CriticalAdaKVPress(SnapKVPress())` | AdaKV çš„å¦ä¸€ä¸ªå˜ä½“ï¼ˆCriticalAdaKVï¼‰ |

**æ¨¡å¼**ï¼š
- `AdaKV` æœ¬èº«ä¸ç›´æ¥å‹ç¼©ï¼Œå®ƒæ˜¯ä¸€ä¸ª**ç­–ç•¥å±‚**
- å†…éƒ¨çš„ `press`ï¼ˆå¦‚ SnapKVï¼‰è´Ÿè´£è®¡ç®—é‡è¦æ€§åˆ†æ•°
- `AdaKV` è´Ÿè´£è·¨ Head åˆ†é…å‹ç¼©é¢„ç®—

---

## ğŸ§  ä¸ºä»€ä¹ˆéœ€è¦ AdaKVï¼Ÿ

### è®ºæ–‡åŠ¨æœº (AdaKV, arXiv:2407.11550)
- **è§‚å¯Ÿ**ï¼šä¸åŒ Attention Head å…³æ³¨çš„ä¿¡æ¯ç²’åº¦ä¸åŒ
  - æŸäº› Head å…³æ³¨**å±€éƒ¨ä¾èµ–**ï¼ˆå¦‚ç›¸é‚»è¯å…³ç³»ï¼‰ï¼Œä¸éœ€è¦å¤ªé•¿å†å²
  - æŸäº› Head å…³æ³¨**é•¿ç¨‹ä¾èµ–**ï¼ˆå¦‚æ–‡æ¡£çº§å¼•ç”¨ï¼‰ï¼Œéœ€è¦ä¿ç•™æ›´å¤šå†å²

- **é—®é¢˜**ï¼šä¼ ç»Ÿæ–¹æ³•å¯¹æ‰€æœ‰ Head ä¸€è§†åŒä»ï¼Œå¯¼è‡´èµ„æºæµªè´¹

- **è§£å†³**ï¼šAdaKV å…è®¸"é‡è¦çš„ Head å¤šä¿ç•™ï¼Œä¸é‡è¦çš„ Head å°‘ä¿ç•™"

---

## ğŸ’¡ ä»£ç å±‚é¢çš„å…³é”®å·®å¼‚

### SnapKV (scorer_press.py ç¬¬ 76-102 è¡Œ)
```python
def compress(self, ...):
    scores = self.score(...)  # å½¢çŠ¶: [BSZ, num_heads, seq_len]
    
    # æ¯ä¸ª Head ç‹¬ç«‹é€‰æ‹© Top-K
    for each head:
        indices = scores[head].topk(n_kept)
        keys[head] = keys[head].gather(indices)
```

### AdaKV (adakv_press.py ç¬¬ 53-78 è¡Œ)
```python
def compress(self, ...):
    scores = self.press.score(...)  # è°ƒç”¨å†…éƒ¨ press (å¦‚ SnapKV)
    
    # 1. å®‰å…¨ä¿æŠ¤ï¼šç¡®ä¿æ¯ä¸ª Head è‡³å°‘ä¿ç•™ n_safe ä¸ª Token
    n_safe = int(n_kept * 0.20)
    for each head:
        top_safe = scores[head].topk(n_safe)
        scores[head][top_safe] = MAX  # æ ‡è®°ä¸ºå¿…é¡»ä¿ç•™

    # 2. è·¨ Head å…¨å±€é€‰æ‹©ï¼šåœ¨æ‰€æœ‰ Head ä¸­æ‰¾å‡ºæœ€ä¸é‡è¦çš„ Token å¹¶åˆ é™¤
    all_scores = scores.reshape(bsz, -1)  # æ‹‰å¹³æ‰€æœ‰ Head
    to_prune = topk(-all_scores, n_pruned)  # å…¨å±€æœ€å·®çš„ Token
    
    # 3. é€šè¿‡ mask æœºåˆ¶å®ç°ä¸åŒ Head ä¿ç•™ä¸åŒæ•°é‡
    module.masked_key_indices = (batch, head, seq) åæ ‡
```

---

## âœ… æ€»ç»“

### adakv_snapkv
- **ç»“æ„**ï¼š`AdaKV( SnapKV )`
- **è¯„åˆ†**ï¼šSnapKV è®¡ç®—é‡è¦æ€§ï¼ˆåŸºäºæœ€åçª—å£çš„æ³¨æ„åŠ›ï¼‰
- **å‹ç¼©**ï¼šAdaKV è·¨ Head è‡ªé€‚åº”åˆ†é…ä¿ç•™çš„ Token
- **ä¼˜åŠ¿**ï¼šåœ¨ç›¸åŒæ€» KV å¯¹æ•°ä¸‹ï¼Œæ€§èƒ½æ›´å¥½

### ä¸ºä»€ä¹ˆæœ‰å¤šä¸ª adakv_xxxï¼Ÿ
- `AdaKV` æ˜¯ä¸€ä¸ª**é€šç”¨æ¡†æ¶**ï¼Œå¯ä»¥ä¸ä»»ä½•è¯„åˆ†æ–¹æ³•ç»“åˆ
- `adakv_snapkv` = AdaKV + SnapKV è¯„åˆ†
- `adakv_compactor` = AdaKV + Compactor è¯„åˆ†
- è¿™æ ·å¯ä»¥æµ‹è¯•ä¸åŒè¯„åˆ†æ–¹æ³•åœ¨è‡ªé€‚åº”å‹ç¼©ä¸‹çš„è¡¨ç°

### ä½•æ—¶ç”¨å“ªä¸ªï¼Ÿ
- **snapkv**ï¼šç®€å•å¿«é€Ÿï¼Œé€‚åˆå¿«é€Ÿå®éªŒ
- **adakv_snapkv**ï¼šæ€§èƒ½æ›´å¥½ï¼Œé€‚åˆè¿½æ±‚ç²¾åº¦çš„åœºæ™¯ï¼ˆè®¡ç®—å¼€é”€ç•¥é«˜ï¼‰
